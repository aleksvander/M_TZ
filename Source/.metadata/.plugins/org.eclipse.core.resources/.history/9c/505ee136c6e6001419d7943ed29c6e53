<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ajax Get JSON Demo</title>
<script type="text/javascript">
function createXHR() {
    var request = false;
    try {
        request = new ActiveXObject('Msxml2.XMLHTTP');
    } catch (err2) {
        try {
            request = new ActiveXObject('Microsoft.XMLHTTP');
        } catch (err3) {
            try {
                request = new XMLHttpRequest();
            } catch (err1) {
                request = false;
            }
        }
    }
    return request;
}

function loadJSON(fname) {
    var xhr = createXHR();
    var data = "";
    //Не асинхронный - false
    xhr.open("GET", fname, false);
    xhr.onreadystatechange = function() {
    	if (xhr.readyState == 4) {
    		if (xhr.status != 404) {
				data = eval("(" + xhr.responseText + ")");
    		}
       	}
    }
    //var obj = new loadJSON();
    //alert(obj.data);
    xhr.send(null);
    return data; 
}

function loadJSON2(fname) {
    var xhr = createXHR();
    xhr.open("GET", fname, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            if (xhr.status != 404) {
                var data = eval("(" + xhr.responseText + ")");
                //alert(data[0].id);
                //var x = JSON.parse(xhr.responseText);
                document.getElementById("zone").innerHTML = "<h2>Items:</h2>";
                //for (i = 0; i < 1; i++) {
                    //{"listing":{"items":[{"description":{"$":"computer"},"price":{"$":"2500"}},{"description":{"$":"chair"},"price":{"$":"100"}},{"description":{"$":"table"},"price":{"$":"200"}}]}}    
                    document.getElementById("zone").innerHTML += data[0].name; 
                        //data.listing.id[i].description + ', id <i>' + data.listing.items[i].name + "</i><br/>";
                //}
                //document.getElementById("zone").innerHTML = data.toString();
            } else {
                document.getElementById("zone").innerHTML = fname + " not found";
            }
        }
    }
    xhr.send(null);
}

function login(idInput) {
	if (idInput == "login") {
		createCookie('username', document.getElementById("loginName").value);
	} else {
		deleteCookie('username');
	}
	formOnChange(idInput);
}

function formOnChange(idFormAction) {
	//!!!!!!!!!!!!!!!!! удалить коммент потом
	document.forms[idFormAction].submit();
}

function createCookie(id, name) {
	//var cookie_date = new Date ();
	//expires - не устанавливаем, пускай удаляются при закрытии браузера
	document.cookie = id + "=" + name;
}

function deleteCookie(name) {
	//delete_cookie("username");
	document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
}

//check cookie
function get_cookie ( cookie_name )
{
	//Тут нужно дописать что бы он проверял на username только!
  var results = document.cookie.match ( '(^|;) ?' + cookie_name + '=([^;]*)(;|$)' );
 
  if ( results )
    return ( unescape ( results[2] ) );
  else
    return null;
}

window.onload=function() {
//function initStart() {
	if (get_cookie ('username') == null) {
		//Показываем элементы входа
		onHiddenVisible(false);
	} else {
		//Показываем элементы выхода
		onHiddenVisible(true);
		//Создаем либо достаем пользователя
		var data = loadJSON('rest/users/getOrCreateUser');
		if (data) {
			innTextInHTML('div_nameUser', 'Привет: ' + get_cookie('username')); //data[0].name

			data = null;
			data = loadJSON('rest/tasks/getTaskForUser')
				
			if (data) {
				innTextInHTML('div_currentTask', 'Текущая задача: ' + get_cookie('currentTask')); //data[0].name
			} else {
				//Удаляем куки
			}

		} else {
			innTextInHTML('div_nameUser', '? ERROR ?');
			//Вызываем метод возврата
			login('logout');
		}
	}
}

function onHiddenVisible(isLogin) {
	var vs = 'visible';
	var hd = 'hidden';
	if (!isLogin) {
		setStyleHTMLDiv('div_login', vs);
		setStyleHTMLDiv('div_work', hd);
	} else {
		setStyleHTMLDiv('div_login', hd);
		setStyleHTMLDiv('div_work', vs);
	}
}

function innTextInHTML(id, str) {
	if (id != null) {
		 document.getElementById(id).innerHTML = '<p>' + str + '</p>';
	}
}

function setStyleHTMLDiv(id, str) {
	if (id != null) {
		document.getElementById(id).style.visibility = str;
	}
}

function createTask(name) {
	createCookie('currentTask', name);
	formOnChange('taskCreate');
}

function getTextInHTML(id) {
	return document.getElementById(id).value;
}

function deleteCurentTask() {
	deleteCookie(get_cookie('currentTask'));
	formOnChange('');
}
</script>
</head>

<body bgcolor="#FFFFFF"> <!-- onload="initStart()" -->
<!-- <p>
	<INPUT type="BUTTON" value=" Click to load the JSON file" ONCLICK="loadJSON('rest/users/getAllusers')">
</p> -->
<h3>Авторизация</h3>
<div id = "div_login" style="visibility: hidden;">
	<form id = "login" action="index.html">
	    <input id="loginName" type="text" value=""/>
	    <input type="hidden" value="LOGIN"/>
	    <a href="javascript: login('login')">Вход</a>
    </form>
</div>
<div id = "div_work" style="visibility: hidden;">
	<div id = "div_nameUser"><p>Привет: </p> </div>
	<div id = "div_formNameUser">
		<form id = "logout" action="index.html">    
		    <input type="hidden" value="LOGOUT"/>
		    <a href="javascript: login('logout')">Выход</a>
	    </form>
    </div>
    <hr/>
    <div id = "div_newTask">
    	<div id = "div_newTask">
	    	<h3>Создать новую задачу</h3>
	    	<form id = "taskCreate" action="index.html">
	    		<p>Введите имя задачи: </p><input id="nameTask" type="text" value=""/>
	    		<input type="hidden" value="CreateTask"/>
	    		<a href="javascript: createTask(getTextInHTML('nameTask'))">Старт</a>
	    	</form>
    	</div>
    	<div id = "div_currentTask">
    		<form id = "stopTask" action="index.html">
    			<p></p>
    			<a href="javascript: deleteCurentTask()">Стоп</a>
    		</form>
    	</div>
    </div>
    <br/>
    <hr/>
    <div id = "div_allTask">
    	<h3>Список задач</h3>
    	<!-- Тут надо будет сделать таблицу с записями -->
    </div>
</div>

<div id="zone"></div>

</body>
</html>